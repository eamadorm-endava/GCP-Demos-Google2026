substitutions:
  _REGION: us-west4
  _AR_REPO: GCP-DEMOS-GOOGLE2026
  _SERVICE: agentic-vendor-governance-platform
  _DEMO_DIR: agentic-vendor-governance-platform
  _PROJECT_ID: p-dev-stemilt-0sjp-1

availableSecrets:
  secretManager:
    - versionName: projects/${_PROJECT_ID}/secrets/GEMINI_API_KEY/versions/latest
      env: GEMINI_API_KEY
options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # Build + Push using bash so $GEMINI_API_KEY is expanded at runtime.
  - name: gcr.io/cloud-builders/docker
    entrypoint: bash
    # IMPORTANT: env must be KEY=VALUE. Use $$ to escape Cloud Build substitution.
    env:
      - "GEMINI_API_KEY=$$GEMINI_API_KEY"
    args:
      - -c
      - |
        set -e
        IMAGE="${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_AR_REPO}/${_SERVICE}:${SHORT_SHA}"
        echo "Building image ${IMAGE} with build-arg from secret"
        docker build --build-arg "GEMINI_API_KEY=$GEMINI_API_KEY" -f ${_DEMO_DIR}/Dockerfile -t "${IMAGE}" ${_DEMO_DIR}
        echo "Pushing ${IMAGE} ..."
        docker push "${IMAGE}"
